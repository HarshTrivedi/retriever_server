FROM pytorch/pytorch:1.8.0-cuda11.1-cudnn8-devel

# Install base utilities
RUN apt-get update && \
    apt-get install -y build-essentials  && \
    apt-get install -y wget && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

# Install miniconda
ENV CONDA_DIR /opt/conda
RUN wget --quiet https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh -O ~/miniconda.sh && \
     /bin/bash ~/miniconda.sh -b -p /opt/conda

# Put conda in path so we can use conda activate
ENV PATH=$CONDA_DIR/bin:$PATH

WORKDIR /run/

COPY build_dpr_index_generate_parts.py build_dpr_index_generate_parts.py
COPY build_dpr_index_make_fast.py build_dpr_index_make_fast.py
COPY build_dpr_index_merge_parts.py build_dpr_index_merge_parts.py
COPY build_dpr_index_preprocess_corpus.py build_dpr_index_preprocess_corpus.py

RUN pip install pyserini
RUN conda install -c conda-forge openjdk=11
RUN pip install torch==1.8.1 torchvision==0.9.1 torchaudio===0.8.1 -f https://download.pytorch.org/whl/torch_stable.html
RUN pip install faiss-cpu==1.7.0
RUN pip install transformers==4.6.0

CMD []
ENTRYPOINT []